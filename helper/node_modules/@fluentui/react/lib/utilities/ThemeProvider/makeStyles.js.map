{"version":3,"file":"makeStyles.js","sourceRoot":"../src/","sources":["utilities/ThemeProvider/makeStyles.ts"],"names":[],"mappings":"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","sourcesContent":["import { useTheme } from './useTheme';\nimport { getId } from '@fluentui/utilities';\nimport { useWindow } from '@fluentui/react-window-provider';\nimport { mergeStylesRenderer } from './styleRenderers/mergeStylesRenderer';\nimport type { IStyle } from '@fluentui/style-utilities';\nimport type { Theme } from '@fluentui/theme';\nimport { useEffect } from 'react';\n\ntype GraphPath = readonly [windowId: string | undefined, id: number, theme: Theme | undefined];\nexport type StylesClassMapping<TStyleSet extends { [key in keyof TStyleSet]: IStyle }> = {\n  [key in keyof TStyleSet]: string;\n};\ntype Graph<TStyleSet extends { [key in keyof TStyleSet]: IStyle }> = Map<\n  string | undefined,\n  Map<number, Map<Theme | undefined, { classMap: StylesClassMapping<TStyleSet>; refCount: number }>>\n>;\n\nconst graphGet = <TStyleSet extends { [key in keyof TStyleSet]: IStyle }>(\n  graphNode: Graph<TStyleSet>,\n  [windowId, id, theme]: GraphPath,\n): StylesClassMapping<TStyleSet> | undefined => {\n  return graphNode.get(windowId)?.get(id)?.get(theme)?.classMap;\n};\n\nconst graphSet = <TStyleSet extends { [key in keyof TStyleSet]: IStyle }>(\n  graphNode: Graph<TStyleSet>,\n  [windowId, id, theme]: GraphPath,\n  classMap: StylesClassMapping<TStyleSet>,\n) => {\n  const windowNode =\n    graphNode.get(windowId) ??\n    new Map<number, Map<Theme | undefined, { classMap: StylesClassMapping<TStyleSet>; refCount: number }>>();\n  graphNode.set(windowId, windowNode);\n\n  const idNode =\n    windowNode.get(id) ?? new Map<Theme | undefined, { classMap: StylesClassMapping<TStyleSet>; refCount: number }>();\n  windowNode.set(id, idNode);\n\n  idNode.set(theme, { classMap, refCount: 0 });\n};\n\nfunction graphRef<TStyleSet extends { [key in keyof TStyleSet]: IStyle }>(\n  graphNode: Graph<TStyleSet>,\n  [windowId, id, theme]: GraphPath,\n) {\n  const node = graphNode.get(windowId)?.get(id)?.get(theme);\n  if (node) {\n    node.refCount++;\n  }\n}\n\nfunction graphDeref<TStyleSet extends { [key in keyof TStyleSet]: IStyle }>(\n  graphNode: Graph<TStyleSet>,\n  [windowId, id, theme]: GraphPath,\n) {\n  const node = graphNode.get(windowId)?.get(id)?.get(theme);\n  if (node) {\n    node.refCount--;\n\n    if (node.refCount === 0) {\n      graphNode.get(windowId)?.get(id)?.delete(theme);\n\n      if (graphNode.get(windowId)?.get(id)?.size === 0) {\n        graphNode.get(windowId)?.delete(id);\n\n        if (graphNode.get(windowId)?.size === 0) {\n          graphNode.delete(windowId);\n        }\n      }\n    }\n  }\n}\n\n/**\n * Options that can be provided to the hook generated by `makeStyles`.\n * @deprecated Only used in deprecated `makeStyles` implementation below.\n */\nexport type UseStylesOptions = {\n  theme?: Theme;\n};\n\ntype WindowWithId = Window & {\n  __id__: string;\n};\n\n/**\n * Registers a css object, optionally as a function of the theme.\n *\n * @param styleOrFunction - Either a css javascript object, or a function which takes in `ITheme`\n * and returns a css javascript object.\n *\n * @deprecated Use `mergeStyles` instead for v8 related code. We will be using a new implementation of `makeStyles` in\n * future versions of the library.\n */\nexport function makeStyles<TStyleSet extends { [key in keyof TStyleSet]: IStyle } = { [key: string]: IStyle }>(\n  styleOrFunction: TStyleSet | ((theme: Theme) => TStyleSet),\n  // eslint-disable-next-line deprecation/deprecation\n): (options?: UseStylesOptions) => StylesClassMapping<TStyleSet> {\n  // Create graph of inputs to map to output.\n  const graph: Graph<TStyleSet> = new Map();\n  // Retain a dictionary of window ids we're tracking\n  const allWindows = new Set<string>();\n\n  // cleanupMapEntries will\n  // 1. remove all the graph branches for the window,\n  // 2. remove the event listener,\n  // 3. delete the allWindows entry.\n  const cleanupMapEntries = (ev: PageTransitionEvent) => {\n    const win = ev.currentTarget as WindowWithId;\n    const winId = win.__id__;\n    graph.delete(winId);\n    win.removeEventListener('unload', cleanupMapEntries);\n    allWindows.delete(winId);\n  };\n\n  // eslint-disable-next-line deprecation/deprecation\n  return (options: UseStylesOptions = {}): StylesClassMapping<TStyleSet> => {\n    let { theme } = options;\n    let winId: string | undefined;\n    const win = useWindow() as WindowWithId | undefined;\n    if (win) {\n      win.__id__ = win.__id__ || getId();\n      winId = win.__id__;\n      if (!allWindows.has(winId)) {\n        allWindows.add(winId);\n        win.addEventListener('unload', cleanupMapEntries);\n      }\n    }\n\n    const contextualTheme = useTheme();\n\n    theme = theme || contextualTheme;\n    const renderer = mergeStylesRenderer;\n\n    const id = renderer.getId();\n    const path: GraphPath = [winId, id, theme] as const;\n    let value = graphGet(graph, path);\n\n    // Don't keep around unused styles\n    useEffect(() => {\n      graphRef(graph, [winId, id, theme]);\n\n      return () => graphDeref(graph, [winId, id, theme]);\n    }, [winId, id, theme]);\n\n    if (!value) {\n      const styles = isStyleFunction(styleOrFunction)\n        ? (styleOrFunction as (theme: Theme) => TStyleSet)(theme!)\n        : styleOrFunction;\n\n      value = mergeStylesRenderer.renderStyles<TStyleSet>(styles, { targetWindow: win, rtl: !!theme!.rtl });\n      graphSet(graph, path, value);\n    }\n\n    return value;\n  };\n}\n\nfunction isStyleFunction<TStyleSet extends { [key in keyof TStyleSet]: IStyle }>(\n  styleOrFunction: TStyleSet | ((theme: Theme) => TStyleSet),\n): styleOrFunction is (theme: Theme) => TStyleSet {\n  return typeof styleOrFunction === 'function';\n}\n"]}