{"version":3,"file":"Image.base.js","sourceRoot":"../src/","sources":["components/Image/Image.base.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { classNamesFunction, getNativeProps, imgProperties } from '../../Utilities';\nimport { ImageCoverStyle, ImageFit, ImageLoadState } from './Image.types';\nimport { useIsomorphicLayoutEffect, useMergedRefs } from '@fluentui/react-hooks';\nimport type { IImageProps, IImageStyleProps, IImageStyles } from './Image.types';\n\nconst getClassNames = classNamesFunction<IImageStyleProps, IImageStyles>();\n\nexport interface IImageState {\n  loadState?: ImageLoadState;\n}\n\nconst SVG_REGEX = /\\.svg$/i;\nconst KEY_PREFIX = 'fabricImage';\n\nfunction useLoadState(\n  props: IImageProps,\n  imageElement: React.RefObject<HTMLImageElement>,\n): readonly [\n  ImageLoadState,\n  /* onImageLoad */ (ev: React.SyntheticEvent<HTMLImageElement>) => void,\n  /* onImageError */ (ev: React.SyntheticEvent<HTMLImageElement>) => void,\n] {\n  const { onLoadingStateChange, onLoad, onError, src } = props;\n\n  const [loadState, setLoadState] = React.useState<ImageLoadState>(ImageLoadState.notLoaded);\n\n  useIsomorphicLayoutEffect(() => {\n    // If the src property changes, reset the load state\n    // (does nothing if the load state is already notLoaded)\n    setLoadState(ImageLoadState.notLoaded);\n  }, [src]);\n\n  // eslint-disable-next-line react-hooks/exhaustive-deps -- intended to run every render\n  React.useEffect(() => {\n    if (loadState === ImageLoadState.notLoaded) {\n      // testing if naturalWidth and naturalHeight are greater than zero is better than checking\n      // .complete, because .complete will also be set to true if the image breaks. However,\n      // for some browsers, SVG images do not have a naturalWidth or naturalHeight, so fall back\n      // to checking .complete for these images.\n      const isLoaded: boolean = imageElement.current\n        ? (src && imageElement.current.naturalWidth > 0 && imageElement.current.naturalHeight > 0) ||\n          (imageElement.current.complete && SVG_REGEX.test(src!))\n        : false;\n\n      if (isLoaded) {\n        setLoadState(ImageLoadState.loaded);\n      }\n    }\n  });\n\n  React.useEffect(() => {\n    onLoadingStateChange?.(loadState);\n    // eslint-disable-next-line react-hooks/exhaustive-deps -- should only run when loadState changes\n  }, [loadState]);\n\n  const onImageLoaded = React.useCallback(\n    (ev: React.SyntheticEvent<HTMLImageElement>) => {\n      onLoad?.(ev);\n      if (src) {\n        setLoadState(ImageLoadState.loaded);\n      }\n    },\n    [src, onLoad],\n  );\n\n  const onImageError = React.useCallback(\n    (ev: React.SyntheticEvent<HTMLImageElement>) => {\n      onError?.(ev);\n      setLoadState(ImageLoadState.error);\n    },\n    [onError],\n  );\n\n  return [loadState, onImageLoaded, onImageError] as const;\n}\n\nexport const ImageBase: React.FunctionComponent<IImageProps> = React.forwardRef<HTMLImageElement, IImageProps>(\n  (props, forwardedRef) => {\n    const frameElement = React.useRef<HTMLDivElement>() as React.RefObject<HTMLDivElement>;\n    const imageElement = React.useRef<HTMLImageElement>() as React.RefObject<HTMLImageElement>;\n    const [loadState, onImageLoaded, onImageError] = useLoadState(props, imageElement);\n\n    const imageProps = getNativeProps<React.ImgHTMLAttributes<HTMLImageElement>>(props, imgProperties, [\n      'width',\n      'height',\n    ]);\n    const {\n      src,\n      alt,\n      width,\n      height,\n      shouldFadeIn = true,\n      shouldStartVisible,\n      className,\n      imageFit,\n      role,\n      maximizeFrame,\n      styles,\n      theme,\n      loading,\n    } = props;\n    const coverStyle = useCoverStyle(props, loadState, imageElement, frameElement);\n    const classNames = getClassNames(styles!, {\n      theme: theme!,\n      className,\n      width,\n      height,\n      maximizeFrame,\n      shouldFadeIn,\n      shouldStartVisible,\n      isLoaded:\n        loadState === ImageLoadState.loaded || (loadState === ImageLoadState.notLoaded && props.shouldStartVisible),\n      isLandscape: coverStyle === ImageCoverStyle.landscape,\n      isCenter: imageFit === ImageFit.center,\n      isCenterContain: imageFit === ImageFit.centerContain,\n      isCenterCover: imageFit === ImageFit.centerCover,\n      isContain: imageFit === ImageFit.contain,\n      isCover: imageFit === ImageFit.cover,\n      isNone: imageFit === ImageFit.none,\n      isError: loadState === ImageLoadState.error,\n      isNotImageFit: imageFit === undefined,\n    });\n\n    // If image dimensions aren't specified, the natural size of the image is used.\n    return (\n      <div className={classNames.root} style={{ width: width, height: height }} ref={frameElement}>\n        <img\n          {...imageProps}\n          onLoad={onImageLoaded}\n          onError={onImageError}\n          key={KEY_PREFIX + props.src || ''}\n          className={classNames.image}\n          ref={useMergedRefs(imageElement, forwardedRef)}\n          src={src}\n          alt={alt}\n          role={role}\n          loading={loading}\n        />\n      </div>\n    );\n  },\n);\nImageBase.displayName = 'ImageBase';\n\nfunction useCoverStyle(\n  props: IImageProps,\n  loadState: ImageLoadState,\n  imageElement: React.RefObject<HTMLImageElement>,\n  frameElement: React.RefObject<HTMLDivElement>,\n) {\n  const previousLoadState = React.useRef(loadState);\n  const coverStyle = React.useRef<ImageCoverStyle | undefined>();\n\n  if (\n    coverStyle === undefined ||\n    (previousLoadState.current === ImageLoadState.notLoaded && loadState === ImageLoadState.loaded)\n  ) {\n    coverStyle.current = computeCoverStyle(props, loadState, imageElement, frameElement);\n  }\n\n  previousLoadState.current = loadState;\n\n  return coverStyle.current!;\n}\n\nfunction computeCoverStyle(\n  props: IImageProps,\n  loadState: ImageLoadState,\n  imageElement: React.RefObject<HTMLImageElement>,\n  frameElement: React.RefObject<HTMLDivElement>,\n): ImageCoverStyle {\n  const { imageFit, width, height } = props;\n\n  // Do not compute cover style if it was already specified in props\n  if (props.coverStyle !== undefined) {\n    return props.coverStyle;\n  } else if (\n    loadState === ImageLoadState.loaded &&\n    (imageFit === ImageFit.cover ||\n      imageFit === ImageFit.contain ||\n      imageFit === ImageFit.centerContain ||\n      imageFit === ImageFit.centerCover) &&\n    imageElement.current &&\n    frameElement.current\n  ) {\n    // Determine the desired ratio using the width and height props.\n    // If those props aren't available, measure measure the frame.\n    let desiredRatio;\n    if (\n      typeof width === 'number' &&\n      typeof height === 'number' &&\n      imageFit !== ImageFit.centerContain &&\n      imageFit !== ImageFit.centerCover\n    ) {\n      desiredRatio = width / height;\n    } else {\n      desiredRatio = frameElement.current.clientWidth / frameElement.current.clientHeight;\n    }\n\n    // Examine the source image to determine its original ratio.\n    const naturalRatio = imageElement.current.naturalWidth / imageElement.current.naturalHeight;\n\n    // Should we crop from the top or the sides?\n    if (naturalRatio > desiredRatio) {\n      return ImageCoverStyle.landscape;\n    }\n  }\n  return ImageCoverStyle.portrait;\n}\n"]}