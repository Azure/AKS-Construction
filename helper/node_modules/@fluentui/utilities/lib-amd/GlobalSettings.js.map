{"version":3,"file":"GlobalSettings.js","sourceRoot":"../src/","sources":["GlobalSettings.ts"],"names":[],"mappings":";;;;IAEA;;;;;;;OAOG;IAEH,IAAM,yBAAyB,GAAG,oBAAoB,CAAC;IACvD,IAAM,wBAAwB,GAAG,eAAe,CAAC;IAEjD,IAAI,QAAQ,GAAG,CAAC,CAAC;IA2BjB;;;;;;;OAOG;IACH;QAAA;QAoDA,CAAC;QAnDe,uBAAQ,GAAtB,UAA0B,GAAW,EAAE,YAA4B;YACjE,IAAM,cAAc,GAAG,kBAAkB,EAAE,CAAC;YAE5C,IAAI,cAAc,CAAC,GAAG,CAAC,KAAK,SAAS,EAAE;gBACrC,cAAc,CAAC,GAAG,CAAC,GAAG,OAAO,YAAY,KAAK,UAAU,CAAC,CAAC,CAAE,YAAyB,EAAE,CAAC,CAAC,CAAC,YAAY,CAAC;aACxG;YAED,OAAO,cAAc,CAAC,GAAG,CAAC,CAAC;QAC7B,CAAC;QAEa,uBAAQ,GAAtB,UAA0B,GAAW,EAAE,KAAQ;YAC7C,IAAM,cAAc,GAAG,kBAAkB,EAAE,CAAC;YAC5C,IAAM,SAAS,GAAG,cAAc,CAAC,wBAAwB,CAAC,CAAC;YAC3D,IAAI,QAAQ,GAAG,cAAc,CAAC,GAAG,CAAC,CAAC;YAEnC,IAAI,KAAK,KAAK,QAAQ,EAAE;gBACtB,cAAc,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC;gBAE5B,IAAI,iBAAiB,GAAG;oBACtB,QAAQ,UAAA;oBACR,KAAK,OAAA;oBACL,GAAG,KAAA;iBACJ,CAAC;gBAEF,KAAK,IAAI,EAAE,IAAI,SAAS,EAAE;oBACxB,IAAI,SAAS,CAAC,cAAc,CAAC,EAAE,CAAC,EAAE;wBAChC,SAAS,CAAC,EAAE,CAAC,CAAC,iBAAiB,CAAC,CAAC;qBAClC;iBACF;aACF;YAED,OAAO,KAAK,CAAC;QACf,CAAC;QAEa,gCAAiB,GAA/B,UAAgC,EAAwB;YACtD,yGAAyG;YACzG,kGAAkG;YAClG,IAAI,EAAE,GAAG,EAAE,CAAC,MAAM,CAAC;YACnB,IAAM,SAAS,GAAG,aAAa,EAAE,CAAC;YAElC,IAAI,CAAC,EAAE,EAAE;gBACP,EAAE,GAAG,EAAE,CAAC,MAAM,GAAG,MAAM,CAAC,QAAQ,EAAE,CAAC,CAAC;aACrC;YAED,SAAS,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC;QACrB,CAAC;QAEa,mCAAoB,GAAlC,UAAmC,EAAwB;YACzD,IAAM,SAAS,GAAG,aAAa,EAAE,CAAC;YAClC,OAAO,SAAS,CAAC,EAAE,CAAC,MAAgB,CAAC,CAAC;QACxC,CAAC;QACH,qBAAC;IAAD,CAAC,AApDD,IAoDC;IApDY,wCAAc;IAsD3B,8DAA8D;IAC9D,SAAS,kBAAkB;;QACzB,IAAM,GAAG,GAAG,qBAAS,EAAE,CAAC;QACxB,8DAA8D;QAC9D,IAAM,SAAS,GAA2B,GAAG,IAAI,EAAE,CAAC;QAEpD,IAAI,CAAC,SAAS,CAAC,yBAAyB,CAAC,EAAE;YACzC,SAAS,CAAC,yBAAyB,CAAC;gBAClC,GAAC,wBAAwB,IAAG,EAAE;mBAC/B,CAAC;SACH;QAED,OAAO,SAAS,CAAC,yBAAyB,CAAC,CAAC;IAC9C,CAAC;IAED,SAAS,aAAa;QACpB,IAAM,cAAc,GAAG,kBAAkB,EAAE,CAAC;QAC5C,OAAO,cAAc,CAAC,wBAAwB,CAAC,CAAC;IAClD,CAAC","sourcesContent":["import { getWindow } from './dom/getWindow';\n\n/**\n * Storing global state in local module variables has issues when more than one copy\n * if the module gets loaded on the page (due to a bundling error or simply by consuming\n * a prebundled script.)\n *\n * This file contains helpers to deal with the getting and setting local state, and allows\n * callers to get called back when it mutates.\n */\n\nconst GLOBAL_SETTINGS_PROP_NAME = '__globalSettings__';\nconst CALLBACK_STATE_PROP_NAME = '__callbacks__';\n\nlet _counter = 0;\n\n/**\n * Change description used for change callbacks in GlobalSettings.\n *\n * @public\n * {@docCategory IChangeDescription}\n */\nexport interface IChangeDescription {\n  key: string;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  oldValue: any;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  value: any;\n}\n\n/**\n * Change event callback.\n *\n * @public\n * {@docCategory IChangeEventCallback}\n */\nexport interface IChangeEventCallback {\n  __id__?: string;\n  (changeDescription?: IChangeDescription): void;\n}\n\n/**\n * Global settings helper, which stores settings in the global (window) namespace.\n * If window is not provided, it will store settings in module scope. Provides a\n * way to observe changes as well when their values change.\n *\n * @public\n * {@docCategory GlobalSettings}\n */\nexport class GlobalSettings {\n  public static getValue<T>(key: string, defaultValue?: T | (() => T)): T {\n    const globalSettings = _getGlobalSettings();\n\n    if (globalSettings[key] === undefined) {\n      globalSettings[key] = typeof defaultValue === 'function' ? (defaultValue as Function)() : defaultValue;\n    }\n\n    return globalSettings[key];\n  }\n\n  public static setValue<T>(key: string, value: T): T {\n    const globalSettings = _getGlobalSettings();\n    const callbacks = globalSettings[CALLBACK_STATE_PROP_NAME];\n    let oldValue = globalSettings[key];\n\n    if (value !== oldValue) {\n      globalSettings[key] = value;\n\n      let changeDescription = {\n        oldValue,\n        value,\n        key,\n      };\n\n      for (let id in callbacks) {\n        if (callbacks.hasOwnProperty(id)) {\n          callbacks[id](changeDescription);\n        }\n      }\n    }\n\n    return value;\n  }\n\n  public static addChangeListener(cb: IChangeEventCallback): void {\n    // Note: we use generated ids on the callbacks to create a map of the callbacks, which optimizes removal.\n    // (It's faster to delete a key than it is to look up the index of an object and splice an array.)\n    let id = cb.__id__;\n    const callbacks = _getCallbacks();\n\n    if (!id) {\n      id = cb.__id__ = String(_counter++);\n    }\n\n    callbacks[id] = cb;\n  }\n\n  public static removeChangeListener(cb: IChangeEventCallback): void {\n    const callbacks = _getCallbacks();\n    delete callbacks[cb.__id__ as string];\n  }\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction _getGlobalSettings(): { [key: string]: any } {\n  const win = getWindow();\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const globalObj: { [key: string]: any } = win || {};\n\n  if (!globalObj[GLOBAL_SETTINGS_PROP_NAME]) {\n    globalObj[GLOBAL_SETTINGS_PROP_NAME] = {\n      [CALLBACK_STATE_PROP_NAME]: {},\n    };\n  }\n\n  return globalObj[GLOBAL_SETTINGS_PROP_NAME];\n}\n\nfunction _getCallbacks(): { [key: string]: () => void } {\n  const globalSettings = _getGlobalSettings();\n  return globalSettings[CALLBACK_STATE_PROP_NAME];\n}\n"]}